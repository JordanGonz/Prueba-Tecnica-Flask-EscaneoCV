{% extends "base.html" %}

{% block title %}Búsqueda Semántica - Sistema de Reclutamiento IA{% endblock %}

{% block extra_css %}
<style>
#vectorVisualization {
    width: 100%;
    height: 600px;
    background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #2a1a4a 100%);
    border-radius: 15px;
    position: relative;
    overflow: hidden;
    display: block;
    border: 1px solid #444;
    margin-top: 1rem;
    perspective: 1000px;
}

.search-particle {
    position: absolute;
    border-radius: 50%;
    pointer-events: none;
    z-index: 2;
}

.query-particle {
    background: radial-gradient(circle, #00ff88 0%, #00d4ff 100%);
    box-shadow: 0 0 15px #00ff88;
}

.candidate-node {
    position: absolute;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    z-index: 3;
    background: radial-gradient(circle, #ff6b35 0%, #f7931e 100%);
    box-shadow: 0 0 8px rgba(255, 107, 53, 0.5);
}

.candidate-node:hover {
    transform: scale(1.3);
    box-shadow: 0 0 20px rgba(255, 107, 53, 0.8);
}

.candidate-node.matched {
    background: radial-gradient(circle, #00ff88 0%, #00d4ff 100%);
    transform: scale(1.4);
    box-shadow: 0 0 25px #00ff88;
    animation: pulse 2s infinite;
}

.search-wave {
    position: absolute;
    border: 3px solid;
    border-image: linear-gradient(45deg, #00ff88, #00d4ff, #ff6b35) 1;
    border-radius: 50%;
    opacity: 0;
    z-index: 1;
}

.connection-line {
    position: absolute;
    height: 2px;
    background: linear-gradient(90deg, #00ff88, #00d4ff);
    opacity: 0;
    z-index: 1;
    animation: connectionPulse 1.5s ease-in-out;
}

@keyframes pulse {
    0%, 100% { 
        box-shadow: 0 0 25px #00ff88;
        transform: scale(1.4);
    }
    50% { 
        box-shadow: 0 0 35px #00ff88, 0 0 50px #00d4ff;
        transform: scale(1.6);
    }
}

@keyframes searchWave {
    0% {
        width: 0;
        height: 0;
        opacity: 1;
    }
    100% {
        width: 600px;
        height: 600px;
        opacity: 0;
    }
}

@keyframes connectionPulse {
    0% { opacity: 0; }
    50% { opacity: 0.8; }
    100% { opacity: 0; }
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.2);
        opacity: 0.8;
    }
}

@keyframes expand {
    from {
        transform: scale(0);
        opacity: 1;
    }
    to {
        transform: scale(1);
        opacity: 0;
    }
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
    }
    40% {
        transform: translateY(-10px);
    }
    60% {
        transform: translateY(-5px);
    }
}

.search-status {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #00d4ff;
    font-family: 'Courier New', monospace;
    font-size: 16px;
    text-align: center;
    z-index: 4;
    text-shadow: 0 0 10px #00d4ff;
}

.vector-count {
    position: absolute;
    top: 15px;
    right: 15px;
    color: #888;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    z-index: 4;
}

.search-input-container {
    position: relative;
    margin-bottom: 2rem;
}

.search-input-glow {
    background: linear-gradient(45deg, #1a1a2e, #16213e);
    border: 2px solid #333;
    border-radius: 15px;
    padding: 1rem;
    transition: all 0.3s ease;
}

.search-input-glow:focus-within {
    border-color: #00d4ff;
    box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
}

.results-container {
    margin-top: 2rem;
}

.candidate-card {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border: 1px solid #333;
    border-radius: 10px;
    transition: all 0.3s ease;
    margin-bottom: 1rem;
}

.candidate-card:hover {
    border-color: #00d4ff;
    box-shadow: 0 5px 20px rgba(0, 212, 255, 0.2);
    transform: translateY(-2px);
}

.similarity-score {
    background: linear-gradient(45deg, #00ff88, #00d4ff);
    color: #000;
    padding: 0.25rem 0.5rem;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.8rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="display-6 text-white">
                    <i class="fas fa-brain me-3 text-primary"></i>
                    Búsqueda Semántica IA
                </h1>
                <div>
                    <a href="{{ url_for('candidates') }}" class="btn btn-outline-light me-2">
                        <i class="fas fa-list me-2"></i>Todos los Candidatos
                    </a>
                    <a href="{{ url_for('upload_cv') }}" class="btn btn-primary">
                        <i class="fas fa-upload me-2"></i>Subir CV
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="search-input-glow">
                <form id="semanticSearchForm">
                    <div class="row align-items-center">
                        <div class="col-lg-10">
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-dark border-0 text-primary">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" 
                                       class="form-control bg-dark border-0 text-white" 
                                       name="search_query" 
                                       id="search_query"
                                       placeholder="Busca por habilidades, experiencia, educación... ej: 'Python developer con experiencia en machine learning'"
                                       style="background: transparent !important;">
                            </div>
                            <div class="form-text text-muted mt-2">
                                <i class="fas fa-lightbulb me-1"></i>
                                Prueba: "desarrollador Python", "React", "5 años experiencia", "ciencias de la computación"
                            </div>
                        </div>
                        <div class="col-lg-2">
                            <button type="submit" class="btn btn-primary btn-lg w-100" id="searchBtn">
                                <i class="fas fa-rocket me-2"></i>
                                Buscar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Vector Visualization Container -->
    <div class="row mt-4">
        <div class="col-12">
            <div id="vectorVisualization">
                <div class="vector-count">Vectores: <span id="vectorCount">0</span></div>
                <div class="search-status" id="searchStatus">
                    Preparando espacio vectorial...
                </div>
            </div>
        </div>
    </div>

    <!-- Search Results -->
    <div class="results-container" id="resultsContainer" style="display: none;">
        <div class="row">
            <div class="col-12">
                <h3 class="text-white mb-3">
                    <i class="fas fa-chart-line me-2 text-success"></i>
                    Resultados de Búsqueda Semántica
                </h3>
                <div id="candidatesResults"></div>
            </div>
        </div>
    </div>

    <!-- Quick Search Examples -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card bg-dark border-secondary">
                <div class="card-body">
                    <h6 class="text-white mb-3">Ejemplos de Búsqueda Rápida:</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-outline-primary btn-sm search-example" data-query="Python">
                            Python
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm search-example" data-query="React desarrollador frontend">
                            React Frontend
                        </button>
                        <button type="button" class="btn btn-outline-warning btn-sm search-example" data-query="machine learning inteligencia artificial">
                            Machine Learning
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm search-example" data-query="senior developer 5 años experiencia">
                            Senior Developer
                        </button>
                        <button type="button" class="btn btn-outline-light btn-sm search-example" data-query="full stack JavaScript">
                            Full Stack JS
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let candidates = [];
let isSearching = false;

document.addEventListener('DOMContentLoaded', function() {
    initializeVisualization();
    setupEventListeners();
});

function setupEventListeners() {
    const form = document.getElementById('semanticSearchForm');
    const searchInput = document.getElementById('search_query');
    const searchExamples = document.querySelectorAll('.search-example');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const query = searchInput.value.trim();
        if (query && !isSearching) {
            performSemanticSearch(query);
        }
    });
    
    searchExamples.forEach(button => {
        button.addEventListener('click', function() {
            const query = this.getAttribute('data-query');
            searchInput.value = query;
            performSemanticSearch(query);
        });
    });
    
    searchInput.focus();
}

function initializeVisualization() {
    const visualization = document.getElementById('vectorVisualization');
    const status = document.getElementById('searchStatus');
    
    // Show visualization immediately
    visualization.style.display = 'block';
    status.textContent = 'Inicializando espacio vectorial 3D...';
    
    // Always create the 3D space, even if no candidates yet
    generateCandidateNodes();
}

function generateCandidateNodes() {
    const visualization = document.getElementById('vectorVisualization');
    
    // Clear existing content
    visualization.innerHTML = '';
    
    // Create 3D space container
    const space3D = document.createElement('div');
    space3D.className = 'vector-space-3d';
    space3D.style.position = 'absolute';
    space3D.style.width = '100%';
    space3D.style.height = '100%';
    space3D.style.transformStyle = 'preserve-3d';
    space3D.style.transform = 'rotateX(15deg) rotateY(0deg)';
    visualization.appendChild(space3D);
    
    // Add status display (outside 3D space)
    const status = document.createElement('div');
    status.id = 'searchStatus';
    status.className = 'search-status';
    status.textContent = 'Cargando espacio vectorial...';
    status.style.position = 'absolute';
    status.style.top = '50%';
    status.style.left = '50%';
    status.style.transform = 'translate(-50%, -50%)';
    status.style.color = '#00d4ff';
    status.style.fontFamily = "'Courier New', monospace";
    status.style.fontSize = '16px';
    status.style.textAlign = 'center';
    status.style.zIndex = '100';
    status.style.textShadow = '0 0 10px #00d4ff';
    status.style.pointerEvents = 'none';
    visualization.appendChild(status);
    
    // Add vector count display (outside 3D space)
    const vectorCount = document.createElement('div');
    vectorCount.id = 'vectorCount';
    vectorCount.className = 'vector-count';
    vectorCount.textContent = '0';
    vectorCount.style.position = 'absolute';
    vectorCount.style.top = '15px';
    vectorCount.style.right = '15px';
    vectorCount.style.color = '#888';
    vectorCount.style.fontFamily = "'Courier New', monospace";
    vectorCount.style.fontSize = '14px';
    vectorCount.style.zIndex = '100';
    vectorCount.style.pointerEvents = 'none';
    visualization.appendChild(vectorCount);
    
    // Get real embeddings from candidates
    fetch('/api/candidates-vectors-detailed')
        .then(response => response.json())
        .then(data => {
            console.log('Loaded candidates data:', data);
            const candidatesWithEmbeddings = data.candidates || [];
            
            // Update count display
            vectorCount.textContent = candidatesWithEmbeddings.length;
            
            if (candidatesWithEmbeddings.length > 0) {
                status.textContent = `Espacio vectorial listo - ${candidatesWithEmbeddings.length} candidatos`;
                
                // Generate candidate points with PCA-like distribution
                candidatesWithEmbeddings.forEach((candidate, index) => {
                    createCandidatePoint(space3D, candidate, index, candidatesWithEmbeddings.length);
                });
                
                // Generate additional ambient points for density (more points for better visualization)
                const ambientCount = Math.max(100, candidatesWithEmbeddings.length * 20);
                generateAmbientPoints(space3D, ambientCount);
            } else {
                status.textContent = 'No hay candidatos con embeddings. Sube algunos CVs primero.';
                // Still generate some ambient points for demonstration
                generateAmbientPoints(space3D, 150);
            }
            
            // Add 3D rotation controls
            addRotationControls(space3D);
            
            candidates = candidatesWithEmbeddings;
        })
        .catch(error => {
            console.error('Error loading detailed candidates:', error);
            status.textContent = 'Error cargando candidatos. Generando visualización demo...';
            // Generate demo ambient points
            generateAmbientPoints(space3D, 200);
            addRotationControls(space3D);
        });
}

function createCandidatePoint(space3D, candidate, index, total) {
    const point = document.createElement('div');
    point.className = 'vector-point candidate-point';
    
    // Use PCA-like positioning based on actual embeddings
    let x, y, z;
    if (candidate.embedding && candidate.embedding.length >= 3) {
        // Use first 3 dimensions with PCA transformation
        const pca = performPCA(candidate.embedding.slice(0, 50)); // Use first 50 dims
        x = mapToSpace(pca[0], 100, 500);
        y = mapToSpace(pca[1], 100, 500);
        z = mapToSpace(pca[2], -100, 100);
    } else {
        // Cluster-like fallback distribution
        const cluster = Math.floor(index / (total / 3));
        const clusterCenters = [
            {x: 200, y: 200, z: 0},
            {x: 400, y: 300, z: 50},
            {x: 300, y: 150, z: -30}
        ];
        const center = clusterCenters[cluster] || clusterCenters[0];
        x = center.x + (Math.random() - 0.5) * 120;
        y = center.y + (Math.random() - 0.5) * 120;
        z = center.z + (Math.random() - 0.5) * 60;
    }
    
    // Style the point
    point.style.position = 'absolute';
    point.style.width = '6px';
    point.style.height = '6px';
    point.style.borderRadius = '50%';
    point.style.background = 'radial-gradient(circle, #4a9eff 0%, #2d5aa0 100%)';
    point.style.boxShadow = '0 0 8px rgba(74, 158, 255, 0.6)';
    point.style.left = x + 'px';
    point.style.top = y + 'px';
    point.style.transform = `translateZ(${z}px)`;
    point.style.transition = 'all 0.3s ease';
    point.style.cursor = 'pointer';
    point.style.zIndex = '10';
    
    // Store data
    point.setAttribute('data-candidate-id', candidate.id);
    point.setAttribute('data-candidate-name', candidate.name);
    point.setAttribute('data-embedding', JSON.stringify(candidate.embedding));
    point.setAttribute('data-original-pos', JSON.stringify({x, y, z}));
    
    // Hover effects
    point.addEventListener('mouseenter', () => {
        point.style.transform = `translateZ(${z + 20}px) scale(2)`;
        point.style.background = 'radial-gradient(circle, #ff6b6b 0%, #ee5a24 100%)';
        point.style.boxShadow = '0 0 15px rgba(255, 107, 107, 0.8)';
        
        // Show tooltip
        showPointTooltip(point, candidate);
    });
    
    point.addEventListener('mouseleave', () => {
        point.style.transform = `translateZ(${z}px) scale(1)`;
        point.style.background = 'radial-gradient(circle, #4a9eff 0%, #2d5aa0 100%)';
        point.style.boxShadow = '0 0 8px rgba(74, 158, 255, 0.6)';
        hidePointTooltip();
    });
    
    point.addEventListener('click', () => {
        window.open(`/candidate/${candidate.id}`, '_blank');
    });
    
    space3D.appendChild(point);
}

function generateAmbientPoints(space3D, count) {
    for (let i = 0; i < count; i++) {
        const point = document.createElement('div');
        point.className = 'vector-point ambient-point';
        
        // Random distribution with some clustering
        const x = Math.random() * 600;
        const y = Math.random() * 600;
        const z = (Math.random() - 0.5) * 200;
        
        point.style.position = 'absolute';
        point.style.width = '2px';
        point.style.height = '2px';
        point.style.borderRadius = '50%';
        point.style.background = `rgba(100, 150, 255, ${0.3 + Math.random() * 0.4})`;
        point.style.left = x + 'px';
        point.style.top = y + 'px';
        point.style.transform = `translateZ(${z}px)`;
        point.style.pointerEvents = 'none';
        
        space3D.appendChild(point);
    }
}

function performPCA(embedding) {
    // Simplified PCA for 3D projection
    const mean = embedding.reduce((sum, val) => sum + val, 0) / embedding.length;
    const centered = embedding.map(val => val - mean);
    
    // Simple projection to 3 dimensions
    return [
        centered.slice(0, 17).reduce((sum, val) => sum + val, 0),
        centered.slice(17, 34).reduce((sum, val) => sum + val, 0),
        centered.slice(34, 51).reduce((sum, val) => sum + val, 0)
    ];
}

function mapToSpace(value, min, max) {
    const normalized = Math.tanh(value / 10); // Normalize to [-1, 1]
    return min + (normalized + 1) * (max - min) / 2;
}

function addRotationControls(space3D) {
    let rotationX = 15;
    let rotationY = 0;
    let isRotating = false;
    
    const visualization = document.getElementById('vectorVisualization');
    
    // Very slow auto-rotation
    const autoRotate = setInterval(() => {
        if (!isRotating) {
            rotationY += 0.1; // Much slower rotation
            space3D.style.transform = `rotateX(${rotationX}deg) rotateY(${rotationY}deg)`;
        }
    }, 200); // Less frequent updates
    
    // Manual rotation with mouse
    visualization.addEventListener('mousedown', (e) => {
        isRotating = true;
        const startX = e.clientX;
        const startY = e.clientY;
        const startRotationX = rotationX;
        const startRotationY = rotationY;
        
        const handleMouseMove = (e) => {
            const deltaX = (e.clientX - startX) * 0.2; // Reduced sensitivity
            const deltaY = (e.clientY - startY) * 0.2;
            
            rotationY = startRotationY + deltaX;
            rotationX = startRotationX - deltaY;
            rotationX = Math.max(-30, Math.min(60, rotationX)); // Limit vertical rotation
            
            space3D.style.transform = `rotateX(${rotationX}deg) rotateY(${rotationY}deg)`;
        };
        
        const handleMouseUp = () => {
            isRotating = false;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        };
        
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
    });
    
    // Add visual feedback for interactivity
    visualization.style.cursor = 'grab';
    visualization.addEventListener('mousedown', () => {
        visualization.style.cursor = 'grabbing';
    });
    document.addEventListener('mouseup', () => {
        visualization.style.cursor = 'grab';
    });
}

function showPointTooltip(point, candidate) {
    const tooltip = document.createElement('div');
    tooltip.className = 'point-tooltip';
    tooltip.innerHTML = `
        <div style="font-weight: bold; color: #fff;">${candidate.name}</div>
        <div style="color: #ccc; font-size: 12px;">${candidate.email || 'Sin email'}</div>
        <div style="color: #9cf; font-size: 11px;">Habilidades: ${candidate.skills ? JSON.parse(candidate.skills).slice(0,2).join(', ') : 'N/A'}</div>
    `;
    tooltip.style.position = 'absolute';
    tooltip.style.background = 'rgba(0, 0, 0, 0.9)';
    tooltip.style.padding = '8px';
    tooltip.style.borderRadius = '6px';
    tooltip.style.fontSize = '12px';
    tooltip.style.zIndex = '1000';
    tooltip.style.pointerEvents = 'none';
    tooltip.style.border = '1px solid #555';
    tooltip.style.left = (parseInt(point.style.left) + 20) + 'px';
    tooltip.style.top = (parseInt(point.style.top) - 20) + 'px';
    
    point.parentNode.appendChild(tooltip);
}

function hidePointTooltip() {
    const tooltip = document.querySelector('.point-tooltip');
    if (tooltip) {
        tooltip.remove();
    }
}

function mapEmbeddingToVisualization(embeddingValue, min, max) {
    // Map embedding values (typically between -1 and 1) to visualization coordinates
    const normalized = (embeddingValue + 1) / 2; // Convert from [-1,1] to [0,1]
    return min + normalized * (max - min);
}

function performSemanticSearch(query) {
    if (isSearching) return;
    
    isSearching = true;
    const searchBtn = document.getElementById('searchBtn');
    const status = document.getElementById('searchStatus');
    const visualization = document.getElementById('vectorVisualization');
    
    // Update UI
    searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Buscando...';
    searchBtn.disabled = true;
    visualization.style.display = 'block';
    
    // Clear previous results
    document.querySelectorAll('.candidate-node').forEach(node => {
        node.classList.remove('matched');
    });
    
    // Start animations immediately
    animateVectorSearch(query);
    
    // Perform actual search
    fetch('/api/semantic-search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ query: query })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Search results:', data);
        setTimeout(() => {
            if (data.results && data.results.length > 0) {
                displaySearchResults(data.results);
                highlightMatchedCandidates(data.results);
                status.textContent = `Búsqueda completada - ${data.results.length} coincidencias encontradas`;
            } else {
                status.textContent = 'No se encontraron coincidencias';
                displaySearchResults([]);
            }
            
            isSearching = false;
            searchBtn.innerHTML = '<i class="fas fa-rocket me-2"></i>Buscar';
            searchBtn.disabled = false;
        }, 3000);
    })
    .catch(error => {
        console.error('Search error:', error);
        isSearching = false;
        searchBtn.innerHTML = '<i class="fas fa-rocket me-2"></i>Buscar';
        searchBtn.disabled = false;
        status.textContent = 'Error en la búsqueda: ' + error.message;
    });
}

function animateVectorSearch(query) {
    const visualization = document.getElementById('vectorVisualization');
    const status = document.getElementById('searchStatus');
    const space3D = document.querySelector('.vector-space-3d');
    
    console.log('Starting advanced vector search animation for:', query);
    
    if (!space3D) return;
    
    // Phase 1: Generate query embedding
    status.textContent = 'Generando embedding de consulta...';
    const queryPoint = createQueryPoint(space3D);
    
    // Phase 2: Calculate similarities with all candidates
    setTimeout(() => {
        status.textContent = 'Calculando similitudes vectoriales...';
        animateVectorSimilarityCalculation3D(space3D, queryPoint);
    }, 500);
    
    // Phase 3: Highlight matches
    setTimeout(() => {
        status.textContent = 'Identificando mejores coincidencias...';
        highlightTopMatches(space3D);
    }, 1500);
}

function createQueryPoint(space3D) {
    const queryPoint = document.createElement('div');
    queryPoint.className = 'vector-point query-point';
    queryPoint.style.position = 'absolute';
    queryPoint.style.width = '12px';
    queryPoint.style.height = '12px';
    queryPoint.style.borderRadius = '50%';
    queryPoint.style.background = 'radial-gradient(circle, #ff4757 0%, #c44569 100%)';
    queryPoint.style.boxShadow = '0 0 20px rgba(255, 71, 87, 0.8)';
    queryPoint.style.left = '300px';
    queryPoint.style.top = '300px';
    queryPoint.style.transform = 'translateZ(0px) scale(1.5)';
    queryPoint.style.border = '2px solid #ffffff';
    queryPoint.style.animation = 'pulse 1.5s infinite';
    queryPoint.style.zIndex = '50';
    
    space3D.appendChild(queryPoint);
    return queryPoint;
}

function animateVectorSimilarityCalculation3D(space3D, queryPoint) {
    const candidatePoints = space3D.querySelectorAll('.candidate-point');
    const queryPos = {
        x: parseInt(queryPoint.style.left),
        y: parseInt(queryPoint.style.top),
        z: 0
    };
    
    candidatePoints.forEach((point, index) => {
        setTimeout(() => {
            // Calculate distance for visual similarity
            const pointPos = {
                x: parseInt(point.style.left),
                y: parseInt(point.style.top),
                z: parseFloat(point.style.transform.match(/translateZ\(([^)]+)px\)/)?.[1] || 0)
            };
            
            const distance = Math.sqrt(
                Math.pow(queryPos.x - pointPos.x, 2) + 
                Math.pow(queryPos.y - pointPos.y, 2) + 
                Math.pow(queryPos.z - pointPos.z, 2)
            );
            
            // Create connection line
            const line = createConnectionLine3D(queryPos, pointPos, distance);
            space3D.appendChild(line);
            
            // Animate point
            point.style.transform = `translateZ(${pointPos.z}px) scale(1.8)`;
            const similarity = Math.max(0, 1 - distance / 500);
            const intensity = similarity * 0.8 + 0.2;
            
            if (similarity > 0.3) {
                point.style.background = `radial-gradient(circle, rgba(0, 255, 136, ${intensity}) 0%, rgba(0, 212, 255, ${intensity * 0.8}) 100%)`;
                point.style.boxShadow = `0 0 15px rgba(0, 255, 136, ${intensity})`;
            }
            
            // Clean up after animation
            setTimeout(() => {
                point.style.transform = `translateZ(${pointPos.z}px) scale(1)`;
                if (line.parentNode) line.parentNode.removeChild(line);
            }, 1000);
            
        }, index * 100);
    });
}

function createConnectionLine3D(pos1, pos2, distance) {
    const line = document.createElement('div');
    line.className = 'connection-line-3d';
    
    const length = Math.sqrt(
        Math.pow(pos2.x - pos1.x, 2) + 
        Math.pow(pos2.y - pos1.y, 2)
    );
    const angle = Math.atan2(pos2.y - pos1.y, pos2.x - pos1.x) * 180 / Math.PI;
    
    const similarity = Math.max(0, 1 - distance / 500);
    const opacity = similarity * 0.6 + 0.1;
    
    line.style.position = 'absolute';
    line.style.width = length + 'px';
    line.style.height = '1px';
    line.style.background = `linear-gradient(90deg, 
        rgba(255, 71, 87, ${opacity}) 0%, 
        rgba(0, 255, 136, ${opacity}) 100%)`;
    line.style.left = pos1.x + 'px';
    line.style.top = pos1.y + 'px';
    line.style.transformOrigin = '0 50%';
    line.style.transform = `rotate(${angle}deg) translateZ(${(pos1.z + pos2.z) / 2}px)`;
    line.style.animation = 'connectionPulse 1s ease-out';
    line.style.zIndex = '20';
    
    return line;
}

function highlightTopMatches(space3D) {
    const candidatePoints = space3D.querySelectorAll('.candidate-point');
    const queryPoint = space3D.querySelector('.query-point');
    
    if (!queryPoint) return;
    
    const queryPos = {
        x: parseInt(queryPoint.style.left),
        y: parseInt(queryPoint.style.top),
        z: 0
    };
    
    // Calculate distances and sort
    const pointsWithDistance = Array.from(candidatePoints).map(point => {
        const pointPos = {
            x: parseInt(point.style.left),
            y: parseInt(point.style.top),
            z: parseFloat(point.style.transform.match(/translateZ\(([^)]+)px\)/)?.[1] || 0)
        };
        
        const distance = Math.sqrt(
            Math.pow(queryPos.x - pointPos.x, 2) + 
            Math.pow(queryPos.y - pointPos.y, 2) + 
            Math.pow(queryPos.z - pointPos.z, 2)
        );
        
        return { point, distance };
    }).sort((a, b) => a.distance - b.distance);
    
    // Highlight top 3 matches
    const colors = [
        { bg: 'radial-gradient(circle, #00ff88 0%, #00d4ff 100%)', shadow: '0 0 25px #00ff88' },
        { bg: 'radial-gradient(circle, #ffd700 0%, #ffb347 100%)', shadow: '0 0 20px #ffd700' },
        { bg: 'radial-gradient(circle, #ff6b6b 0%, #ee5a24 100%)', shadow: '0 0 15px #ff6b6b' }
    ];
    
    pointsWithDistance.slice(0, 3).forEach(({ point }, index) => {
        setTimeout(() => {
            point.style.background = colors[index].bg;
            point.style.boxShadow = colors[index].shadow;
            point.style.transform = point.style.transform.replace(/scale\([^)]*\)/, 'scale(2)');
            point.style.animation = 'bounce 0.8s ease-in-out';
        }, index * 300);
    });
}

function createQueryVector() {
    const queryVector = document.createElement('div');
    queryVector.className = 'search-vector query-vector';
    queryVector.style.position = 'absolute';
    queryVector.style.width = '20px';
    queryVector.style.height = '20px';
    queryVector.style.borderRadius = '50%';
    queryVector.style.background = 'radial-gradient(circle, #ff6b6b 0%, #ee5a24 100%)';
    queryVector.style.boxShadow = '0 0 20px #ff6b6b';
    queryVector.style.left = '240px';
    queryVector.style.top = '240px';
    queryVector.style.zIndex = '10';
    queryVector.style.border = '2px solid #ffffff';
    
    // Add pulsing animation
    queryVector.style.animation = 'pulse 1.5s infinite';
    
    return queryVector;
}

function animateQueryEmbeddingGeneration(queryVector) {
    // Create embedding visualization around query vector
    for (let i = 0; i < 8; i++) {
        setTimeout(() => {
            const embeddingRing = document.createElement('div');
            embeddingRing.className = 'embedding-ring';
            embeddingRing.style.position = 'absolute';
            embeddingRing.style.width = (30 + i * 15) + 'px';
            embeddingRing.style.height = (30 + i * 15) + 'px';
            embeddingRing.style.border = '2px solid rgba(255, 107, 107, 0.3)';
            embeddingRing.style.borderRadius = '50%';
            embeddingRing.style.left = (250 - (15 + i * 7.5)) + 'px';
            embeddingRing.style.top = (250 - (15 + i * 7.5)) + 'px';
            embeddingRing.style.animation = 'expand 1s ease-out forwards';
            
            queryVector.parentNode.appendChild(embeddingRing);
            
            // Remove after animation
            setTimeout(() => {
                if (embeddingRing.parentNode) {
                    embeddingRing.parentNode.removeChild(embeddingRing);
                }
            }, 1000);
        }, i * 100);
    }
}

function animateVectorSimilarityCalculation() {
    const candidateNodes = document.querySelectorAll('.candidate-node');
    
    candidateNodes.forEach((node, index) => {
        setTimeout(() => {
            // Create similarity calculation line
            const line = createSimilarityLine(250, 250, 
                parseInt(node.style.left), parseInt(node.style.top));
            node.parentNode.appendChild(line);
            
            // Animate calculation
            node.style.transform = 'scale(1.5)';
            node.style.boxShadow = '0 0 15px #00d4ff';
            
            // Show similarity percentage
            setTimeout(() => {
                const embedding = JSON.parse(node.getAttribute('data-embedding') || '[]');
                const similarity = calculateMockSimilarity(embedding);
                
                const simLabel = document.createElement('div');
                simLabel.className = 'similarity-label';
                simLabel.textContent = `${(similarity * 100).toFixed(1)}%`;
                simLabel.style.position = 'absolute';
                simLabel.style.left = (parseInt(node.style.left) + 20) + 'px';
                simLabel.style.top = (parseInt(node.style.top) - 10) + 'px';
                simLabel.style.color = '#ffffff';
                simLabel.style.fontSize = '12px';
                simLabel.style.fontWeight = 'bold';
                simLabel.style.background = 'rgba(0, 0, 0, 0.7)';
                simLabel.style.padding = '2px 6px';
                simLabel.style.borderRadius = '4px';
                simLabel.style.zIndex = '15';
                
                node.parentNode.appendChild(simLabel);
                
                // Clean up after delay
                setTimeout(() => {
                    node.style.transform = 'scale(1)';
                    node.style.boxShadow = '';
                    if (line.parentNode) line.parentNode.removeChild(line);
                    if (simLabel.parentNode) simLabel.parentNode.removeChild(simLabel);
                }, 1500);
            }, 500);
        }, index * 150);
    });
}

function createSimilarityLine(x1, y1, x2, y2) {
    const line = document.createElement('div');
    line.className = 'similarity-line';
    
    const length = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
    const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
    
    line.style.position = 'absolute';
    line.style.width = length + 'px';
    line.style.height = '2px';
    line.style.background = 'linear-gradient(90deg, #ff6b6b 0%, #00d4ff 100%)';
    line.style.left = x1 + 'px';
    line.style.top = y1 + 'px';
    line.style.transformOrigin = '0 50%';
    line.style.transform = `rotate(${angle}deg)`;
    line.style.opacity = '0.7';
    line.style.zIndex = '5';
    
    return line;
}

function calculateMockSimilarity(embedding) {
    // Simulate realistic similarity calculation based on actual embedding
    if (!embedding || embedding.length === 0) return Math.random() * 0.3;
    
    // Use actual embedding values to create realistic similarity
    const magnitude = Math.sqrt(embedding.slice(0, 10).reduce((sum, val) => sum + val * val, 0));
    const normalized = magnitude / 10; // Normalize to reasonable range
    return Math.min(Math.max(normalized + Math.random() * 0.2 - 0.1, 0), 1);
}

function animateResultRanking() {
    const candidateNodes = document.querySelectorAll('.candidate-node');
    
    // Sort nodes by position (simulate ranking)
    const sortedNodes = Array.from(candidateNodes).sort((a, b) => {
        const aDistance = Math.sqrt((parseInt(a.style.left) - 250) ** 2 + (parseInt(a.style.top) - 250) ** 2);
        const bDistance = Math.sqrt((parseInt(b.style.left) - 250) ** 2 + (parseInt(b.style.top) - 250) ** 2);
        return aDistance - bDistance;
    });
    
    // Highlight top matches
    sortedNodes.slice(0, 3).forEach((node, index) => {
        setTimeout(() => {
            const colors = ['#00ff88', '#00d4ff', '#ffd700'];
            node.style.background = colors[index];
            node.style.boxShadow = `0 0 20px ${colors[index]}`;
            node.style.animation = 'bounce 0.5s ease-in-out';
        }, index * 200);
    });
}

function createSearchWave() {
    const wave = document.createElement('div');
    wave.className = 'search-wave';
    
    const visualization = document.getElementById('vectorVisualization');
    const rect = visualization.getBoundingClientRect();
    
    wave.style.left = (rect.width / 2) + 'px';
    wave.style.top = (rect.height / 2) + 'px';
    wave.style.animation = 'searchWave 2s ease-out forwards';
    
    setTimeout(() => {
        if (wave.parentNode) {
            wave.parentNode.removeChild(wave);
        }
    }, 2000);
    
    return wave;
}

function createQueryParticle() {
    const particle = document.createElement('div');
    particle.style.position = 'absolute';
    particle.style.borderRadius = '50%';
    particle.style.pointerEvents = 'none';
    particle.style.zIndex = '5';
    
    const size = 6 + Math.random() * 8;
    particle.style.width = size + 'px';
    particle.style.height = size + 'px';
    particle.style.background = 'radial-gradient(circle, #00ff88 0%, #00d4ff 100%)';
    particle.style.boxShadow = '0 0 15px #00ff88';
    
    const visualization = document.getElementById('vectorVisualization');
    
    const x = Math.random() * 450 + 25; // Keep within bounds
    const y = Math.random() * 450 + 25;
    
    particle.style.left = x + 'px';
    particle.style.top = y + 'px';
    particle.style.opacity = '1';
    
    visualization.appendChild(particle);
    
    // Simple movement animation
    const targetX = 250; // Center
    const targetY = 250;
    
    let startTime = Date.now();
    const duration = 2000;
    
    function animateParticle() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        const currentX = x + (targetX - x) * progress;
        const currentY = y + (targetY - y) * progress;
        const currentOpacity = 1 - progress;
        
        particle.style.left = currentX + 'px';
        particle.style.top = currentY + 'px';
        particle.style.opacity = currentOpacity;
        
        if (progress < 1) {
            requestAnimationFrame(animateParticle);
        } else {
            if (particle.parentNode) {
                particle.parentNode.removeChild(particle);
            }
        }
    }
    
    requestAnimationFrame(animateParticle);
}

function highlightMatchedCandidates(results) {
    results.forEach(result => {
        const node = document.querySelector(`[data-candidate-id="${result.id}"]`);
        if (node) {
            node.classList.add('matched');
            
            // Create connection line
            const line = createConnectionLine(node);
            document.getElementById('vectorVisualization').appendChild(line);
        }
    });
}

function createConnectionLine(node) {
    const line = document.createElement('div');
    line.className = 'connection-line';
    
    const visualization = document.getElementById('vectorVisualization');
    const rect = visualization.getBoundingClientRect();
    const nodeRect = node.getBoundingClientRect();
    
    const centerX = rect.width / 2;
    const centerY = rect.height / 2;
    const nodeX = nodeRect.left - rect.left + nodeRect.width / 2;
    const nodeY = nodeRect.top - rect.top + nodeRect.height / 2;
    
    const length = Math.sqrt(Math.pow(nodeX - centerX, 2) + Math.pow(nodeY - centerY, 2));
    const angle = Math.atan2(nodeY - centerY, nodeX - centerX) * 180 / Math.PI;
    
    line.style.width = length + 'px';
    line.style.left = centerX + 'px';
    line.style.top = centerY + 'px';
    line.style.transform = `rotate(${angle}deg)`;
    line.style.transformOrigin = '0 50%';
    
    setTimeout(() => {
        if (line.parentNode) {
            line.parentNode.removeChild(line);
        }
    }, 1500);
    
    return line;
}

function displaySearchResults(results) {
    const container = document.getElementById('resultsContainer');
    const resultsDiv = document.getElementById('candidatesResults');
    
    if (results.length === 0) {
        resultsDiv.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-search fa-3x mb-3"></i>
                <h5>No se encontraron candidatos</h5>
                <p>Intenta con términos de búsqueda diferentes</p>
            </div>
        `;
    } else {
        resultsDiv.innerHTML = results.map(candidate => `
            <div class="candidate-card p-3">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" 
                                 style="width: 50px; height: 50px;">
                                <span class="text-white fw-bold fs-5">
                                    ${candidate.name ? candidate.name[0] : 'U'}
                                </span>
                            </div>
                            <div>
                                <h5 class="text-white mb-1">${candidate.name}</h5>
                                <p class="text-muted mb-0">
                                    ${candidate.email ? `<i class="fas fa-envelope me-2"></i>${candidate.email}` : ''}
                                    ${candidate.phone ? `<i class="fas fa-phone ms-3 me-2"></i>${candidate.phone}` : ''}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 text-center">
                        <div class="similarity-score">
                            ${Math.round(candidate.similarity * 100)}% Match
                        </div>
                    </div>
                    <div class="col-md-2 text-end">
                        <a href="/candidate/${candidate.id}" class="btn btn-outline-primary" target="_blank">
                            <i class="fas fa-eye me-1"></i>Ver Perfil
                        </a>
                    </div>
                </div>
                ${candidate.skills ? `
                    <div class="mt-2">
                        <small class="text-muted">Habilidades:</small>
                        <div class="mt-1">
                            ${JSON.parse(candidate.skills).slice(0, 5).map(skill => 
                                `<span class="badge bg-secondary me-1">${skill}</span>`
                            ).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        `).join('');
    }
    
    container.style.display = 'block';
    container.scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}